<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¹ Piano Keys</title>
    <link rel="stylesheet" href="css/main.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1><span class="emoji">ğŸ¹</span> <span class="title-text">Piano Keys</span></h1>
            <p class="subtitle">ç‚¹å‡»ç´é”®æˆ–ä½¿ç”¨é”®ç›˜æ¼”å¥</p>
        </header>

        <div class="piano-wrapper">
            <div class="piano" id="piano">
                <!-- ä¸€ä¸ªå…«åº¦çš„ç´é”®ç»“æ„ (C4 - B4) -->
                <div class="octave" data-octave="3">
                    <div class="key white" data-note="C3"><span>Z</span></div>
                    <div class="key black" data-note="C#3"><span>S</span></div>
                    <div class="key white" data-note="D3"><span>X</span></div>
                    <div class="key black" data-note="D#3"><span>D</span></div>
                    <div class="key white" data-note="E3"><span>C</span></div>
                    <div class="key white" data-note="F3"><span>V</span></div>
                    <div class="key black" data-note="F#3"><span>G</span></div>
                    <div class="key white" data-note="G3"><span>B</span></div>
                    <div class="key black" data-note="G#3"><span>H</span></div>
                    <div class="key white" data-note="A3"><span>N</span></div>
                    <div class="key black" data-note="A#3"><span>J</span></div>
                    <div class="key white" data-note="B3"><span>M</span></div>
                </div>

                <div class="octave" data-octave="4">
                    <div class="key white" data-note="C4"><span>Q</span></div>
                    <div class="key black" data-note="C#4"><span>2</span></div>
                    <div class="key white" data-note="D4"><span>W</span></div>
                    <div class="key black" data-note="D#4"><span>3</span></div>
                    <div class="key white" data-note="E4"><span>E</span></div>
                    <div class="key white" data-note="F4"><span>R</span></div>
                    <div class="key black" data-note="F#4"><span>5</span></div>
                    <div class="key white" data-note="G4"><span>T</span></div>
                    <div class="key black" data-note="G#4"><span>6</span></div>
                    <div class="key white" data-note="A4"><span>Y</span></div>
                    <div class="key black" data-note="A#4"><span>7</span></div>
                    <div class="key white" data-note="B4"><span>U</span></div>
                </div>

                <div class="octave" data-octave="5">
                    <div class="key white" data-note="C5"><span>I</span></div>
                    <div class="key black" data-note="C#5"><span>9</span></div>
                    <div class="key white" data-note="D5"><span>O</span></div>
                    <div class="key black" data-note="D#5"><span>0</span></div>
                    <div class="key white" data-note="E5"><span>P</span></div>
                </div>
            </div>
        </div>

        <div class="controls">
            <!-- å·¦ä¾§ï¼šå½“å‰éŸ³ç¬¦ + éŸ³è‰²é€‰æ‹© + æç¤ºæŒ‰é’® -->
            <div class="left-panel">
                <div class="info-box">
                    <div class="current-note" id="currentNote">-</div>
                </div>
                <div class="tone-selector">
                    <label class="tone-label">ğŸµ éŸ³è‰²</label>
                    <select class="tone-select" id="toneSelect">
                        <option value="triangle">ä¸‰è§’æ³¢ (é’¢ç´)</option>
                        <option value="sine">æ­£å¼¦æ³¢ (çº¯éŸ³)</option>
                        <option value="square">æ–¹æ³¢ (æ¸¸æˆ)</option>
                        <option value="sawtooth">é”¯é½¿æ³¢ (ç”µå­)</option>
                    </select>
                </div>
                <button class="help-btn" id="helpBtn">ğŸ’¡ æ“ä½œæç¤º</button>
                <!-- æç¤ºå¼¹çª— -->
                <div class="tips-modal" id="tipsModal">
                    <div class="tips-content">
                        <button class="tips-close" id="tipsClose">Ã—</button>
                        <h3>ğŸ’¡ ä½¿ç”¨æç¤º</h3>
                        <ul>
                            <li>ç‚¹å‡»ç´é”®æ’­æ”¾éŸ³ç¬¦</li>
                            <li>æŒ‰ä½ç´é”®æŒç»­å‘å£°ï¼Œæ¾å¼€åœæ­¢</li>
                            <li>ç™½é”®: Z X C V B N M / Q W E R T Y U I O P</li>
                            <li>é»‘é”®: S D G H J / 2 3 5 6 7 9 0</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- ä¸­é—´ï¼šç´è°±æ˜¾ç¤ºåŒºåŸŸ -->
            <div class="center-panel">
                <div class="sheet-display" id="sheetDisplay">
                    <div class="sheet-placeholder">
                        <span class="placeholder-icon">ğŸ¼</span>
                        <span class="placeholder-text">é€‰æ‹©ä¸€é¦–æ›²ç›®</span>
                    </div>
                </div>
                <div class="sheet-controls">
                    <button class="play-btn" id="playBtn" disabled>
                        <span class="play-icon">â–¶</span>
                        <span class="play-text">æ’­æ”¾</span>
                    </button>
                    <button class="stop-btn" id="stopBtn" disabled>
                        <span class="stop-icon">â– </span>
                        <span class="stop-text">åœæ­¢</span>
                    </button>
                    <button class="notation-btn" id="notationBtn" title="åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼">
                        <span class="notation-icon">âŒ¨</span>
                        <span class="notation-text">æŒ‰é”®</span>
                    </button>
                </div>
            </div>

            <!-- å³ä¾§ï¼šé¢„è®¾ç´è°± -->
            <div class="right-panel">
                <h3 class="panel-title">ğŸ¼ é¢„è®¾ç´è°±</h3>
                <div class="sheet-list">
                    <div class="sheet-item" data-sheet="twinkleChord">
                        <span class="sheet-icon">ğŸ¹</span>
                        <span class="sheet-name">å°æ˜Ÿæ˜Ÿ(å’Œå¼¦ç‰ˆ)</span>
                    </div>
                    <div class="sheet-item" data-sheet="twinkle">
                        <span class="sheet-icon">â­</span>
                        <span class="sheet-name">å°æ˜Ÿæ˜Ÿ</span>
                    </div>
                    <div class="sheet-item" data-sheet="erta">
                        <span class="sheet-icon">ğŸµ</span>
                        <span class="sheet-name">è‡´çˆ±ä¸½ä¸</span>
                    </div>
                    <div class="sheet-item" data-sheet="birthday">
                        <span class="sheet-icon">ğŸ‚</span>
                        <span class="sheet-name">ç”Ÿæ—¥å¿«ä¹</span>
                    </div>
                    <div class="sheet-item" data-sheet="canon">
                        <span class="sheet-icon">ğŸ»</span>
                        <span class="sheet-name">å¡å†œ</span>
                    </div>
                    <div class="sheet-item" data-sheet="ode">
                        <span class="sheet-icon">ğŸŒŸ</span>
                        <span class="sheet-name">æ¬¢ä¹é¢‚</span>
                    </div>
                </div>
            </div>
        </div>

        <footer class="footer">
            <p>Made with â¤ï¸ using Web Audio API</p>
        </footer>
    </div>

    <script src="js/main.js"></script>
    <script>
        // ========== æç¤ºå¼¹çª—æ§åˆ¶ ==========
        const helpBtn = document.getElementById('helpBtn');
        const tipsModal = document.getElementById('tipsModal');
        const tipsClose = document.getElementById('tipsClose');

        helpBtn.addEventListener('click', () => {
            tipsModal.classList.add('show');
        });

        tipsClose.addEventListener('click', () => {
            tipsModal.classList.remove('show');
        });

        tipsModal.addEventListener('click', (e) => {
            if (e.target === tipsModal) {
                tipsModal.classList.remove('show');
            }
        });

        // ========== éŸ³è‰²é€‰æ‹©æ§åˆ¶ ==========
        const toneSelect = document.getElementById('toneSelect');

        // ========== æ‰‹æœºç«–å±æ£€æµ‹ ==========
        function isMobileDevice() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) 
                || ('ontouchstart' in window) 
                || (navigator.maxTouchPoints > 0);
        }

        function checkOrientation() {
            const isMobile = isMobileDevice();
            const isPortrait = window.innerHeight > window.innerWidth;
            
            if (isMobile && isPortrait) {
                document.body.classList.add('mobile-portrait');
            } else {
                document.body.classList.remove('mobile-portrait');
            }
        }

        // åˆå§‹æ£€æµ‹
        checkOrientation();

        // ç›‘å¬çª—å£å¤§å°å˜åŒ–å’Œæ–¹å‘å˜åŒ–
        window.addEventListener('resize', checkOrientation);
        window.addEventListener('orientationchange', checkOrientation);

        // ========== é’¢ç´å¼•æ“åˆå§‹åŒ– ==========
        // åˆå§‹åŒ–é’¢ç´å¼•æ“
        const piano = new SimplePiano({ debug: true });

        // éŸ³è‰²é€‰æ‹©äº‹ä»¶
        toneSelect.addEventListener('change', (e) => {
            piano.setOscType(e.target.value);
        });

        // é”®ç›˜æ˜ å°„è¡¨
        const keyMap = {
            // ä½å…«åº¦ (C3 - B3)
            'z': 'C3', 's': 'C#3', 'x': 'D3', 'd': 'D#3', 'c': 'E3',
            'v': 'F3', 'g': 'F#3', 'b': 'G3', 'h': 'G#3', 'n': 'A3', 'j': 'A#3', 'm': 'B3',
            // ä¸­å…«åº¦ (C4 - B4)
            'q': 'C4', '2': 'C#4', 'w': 'D4', '3': 'D#4', 'e': 'E4',
            'r': 'F4', '5': 'F#4', 't': 'G4', '6': 'G#4', 'y': 'A4', '7': 'A#4', 'u': 'B4',
            // é«˜å…«åº¦ (C5 - E5)
            'i': 'C5', '9': 'C#5', 'o': 'D5', '0': 'D#5', 'p': 'E5'
        };

        // åå‘æ˜ å°„: éŸ³ç¬¦ -> æŒ‰é”®
        const noteToKey = {};
        for (const [key, note] of Object.entries(keyMap)) {
            noteToKey[note] = key.toUpperCase();
        }

        const currentNoteDisplay = document.getElementById('currentNote');

        // æ›´æ–°å½“å‰éŸ³ç¬¦æ˜¾ç¤º
        function updateNoteDisplay(noteName) {
            currentNoteDisplay.textContent = noteName;
            currentNoteDisplay.classList.add('active');
        }

        function clearNoteDisplay() {
            currentNoteDisplay.classList.remove('active');
        }

        // é¼ æ ‡/è§¦æ‘¸äº‹ä»¶ - ç‚¹å‡»ç´é”®
        document.querySelectorAll('.key').forEach(key => {
            const noteName = key.dataset.note;

            key.addEventListener('mousedown', () => {
                piano.startNote(noteName);
                updateNoteDisplay(noteName);
                key.classList.add('pressed');
            });

            key.addEventListener('mouseup', () => {
                piano.stopNote(noteName);
                clearNoteDisplay();
                key.classList.remove('pressed');
            });

            key.addEventListener('mouseleave', () => {
                piano.stopNote(noteName);
                clearNoteDisplay();
                key.classList.remove('pressed');
            });

            // è§¦æ‘¸æ”¯æŒ
            key.addEventListener('touchstart', (e) => {
                e.preventDefault();
                piano.startNote(noteName);
                updateNoteDisplay(noteName);
                key.classList.add('pressed');
            });

            key.addEventListener('touchend', () => {
                piano.stopNote(noteName);
                clearNoteDisplay();
                key.classList.remove('pressed');
            });
        });

        // é”®ç›˜äº‹ä»¶
        const pressedKeys = new Set();

        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap[key] && !pressedKeys.has(key)) {
                pressedKeys.add(key);
                const noteName = keyMap[key];
                piano.startNote(noteName);
                updateNoteDisplay(noteName);

                // é«˜äº®å¯¹åº”ç´é”®
                const keyElement = document.querySelector(`.key[data-note="${noteName}"]`);
                if (keyElement) {
                    keyElement.classList.add('pressed');
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (keyMap[key]) {
                pressedKeys.delete(key);
                const noteName = keyMap[key];
                piano.stopNote(noteName);
                clearNoteDisplay();
                
                const keyElement = document.querySelector(`.key[data-note="${noteName}"]`);
                if (keyElement) {
                    keyElement.classList.remove('pressed');
                }
            }
        });

        // çª—å£å¤±ç„¦æ—¶åœæ­¢æ‰€æœ‰éŸ³ç¬¦
        window.addEventListener('blur', () => {
            piano.stopAllNotes();
            pressedKeys.clear();
            document.querySelectorAll('.key.pressed').forEach(key => {
                key.classList.remove('pressed');
            });
            clearNoteDisplay();
        });

        // ========== é¢„è®¾ç´è°±åŠŸèƒ½ ==========
        let currentSheetItem = null;
        let currentSheetId = null;
        let currentNoteIndex = -1;
        const sheetDisplay = document.getElementById('sheetDisplay');
        const playBtn = document.getElementById('playBtn');
        const stopBtn = document.getElementById('stopBtn');
        const notationBtn = document.getElementById('notationBtn');
        let noteElements = [];
        let showKeyboard = false; // false = éŸ³ç¬¦åç§°, true = é”®ç›˜æŒ‰é”®

        // éŸ³ç¬¦è½¬æŒ‰é”®æ˜¾ç¤º
        function noteToDisplay(note) {
            if (showKeyboard) {
                return noteToKey[note] || note;
            }
            return note;
        }

        // æ¸²æŸ“ç´è°±åˆ°ä¸­é—´é¢æ¿
        function renderSheet(sheetId) {
            const sheet = piano.getSheet(sheetId);
            if (!sheet) return;
            
            sheetDisplay.innerHTML = '';
            noteElements = [];
            currentNoteIndex = -1;
            
            sheet.notes.forEach((noteItem, index) => {
                const noteDiv = document.createElement('div');
                noteDiv.className = 'note-item';
                
                const note = noteItem[0]; // noteItem æ˜¯ [note, duration] æ•°ç»„
                noteDiv.dataset.note = JSON.stringify(note); // ä¿å­˜åŸå§‹éŸ³ç¬¦æ•°æ®
                
                // å’Œå¼¦æ˜¾ç¤º: æ•°ç»„æ—¶æ˜¾ç¤ºä¸º "â™«n" (nä¸ºéŸ³ç¬¦æ•°é‡) æˆ–ä¼‘æ­¢ç¬¦æ˜¾ç¤ºä¸º "Â·"
                if (Array.isArray(note)) {
                    if (showKeyboard) {
                        // é”®ç›˜æ¨¡å¼ï¼šæ˜¾ç¤ºæŒ‰é”®ç»„åˆ
                        const keys = note.map(n => noteToKey[n] || '?').join('');
                        noteDiv.textContent = keys.length > 3 ? keys.slice(0, 3) + '..' : keys;
                    } else {
                        noteDiv.textContent = `â™«${note.length}`;
                    }
                    noteDiv.title = note.join(' + ');
                    noteDiv.classList.add('chord');
                } else if (note === 'R' || note === 'REST' || note === '-') {
                    noteDiv.textContent = 'Â·';
                    noteDiv.classList.add('rest');
                } else {
                    noteDiv.textContent = noteToDisplay(note);
                }
                
                noteDiv.dataset.index = index;
                noteElements.push(noteDiv);
                sheetDisplay.appendChild(noteDiv);
            });
        }

        // é«˜äº®ç´é”®å¹¶æ›´æ–°ç´è°±æ˜¾ç¤ºçš„å›è°ƒå‡½æ•°
        function onNotePlay(note, duration, noteIndex) {
            updateNoteDisplay(note);
            
            // æ›´æ–°ç´è°±æ˜¾ç¤ºä¸­çš„å½“å‰éŸ³ç¬¦
            if (currentNoteIndex >= 0 && currentNoteIndex < noteElements.length) {
                noteElements[currentNoteIndex].classList.remove('current');
                noteElements[currentNoteIndex].classList.add('played');
            }
            currentNoteIndex = noteIndex;
            if (currentNoteIndex >= 0 && currentNoteIndex < noteElements.length) {
                noteElements[currentNoteIndex].classList.add('current');
                // æ»šåŠ¨åˆ°å¯è§åŒºåŸŸ
                noteElements[currentNoteIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            }
            
            const keyElement = document.querySelector(`.key[data-note="${note}"]`);
            if (keyElement) {
                keyElement.classList.add('pressed');
                setTimeout(() => {
                    keyElement.classList.remove('pressed');
                }, duration * 0.8);
            }
        }

        // æ’­æ”¾ç»“æŸçš„å›è°ƒå‡½æ•°
        function onSheetEnd() {
            if (currentSheetItem) {
                currentSheetItem.classList.remove('playing');
            }
            clearNoteDisplay();
            updateControlButtons(false);
            
            // æ ‡è®°æœ€åä¸€ä¸ªéŸ³ç¬¦ä¸ºå·²æ’­æ”¾
            if (currentNoteIndex >= 0 && currentNoteIndex < noteElements.length) {
                noteElements[currentNoteIndex].classList.remove('current');
                noteElements[currentNoteIndex].classList.add('played');
            }
        }

        // æ›´æ–°æ§åˆ¶æŒ‰é’®çŠ¶æ€
        function updateControlButtons(isPlaying) {
            if (isPlaying) {
                playBtn.disabled = true;
                stopBtn.disabled = false;
            } else if (currentSheetId) {
                playBtn.disabled = false;
                stopBtn.disabled = true;
            } else {
                playBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }

        // åœæ­¢æ’­æ”¾å¹¶æ¸…ç†UI
        function stopSheetUI() {
            piano.stopSheet();
            
            document.querySelectorAll('.key.pressed').forEach(key => {
                key.classList.remove('pressed');
            });

            if (currentSheetItem) {
                currentSheetItem.classList.remove('playing');
            }

            clearNoteDisplay();
            updateControlButtons(false);
        }

        // é‡ç½®ç´è°±æ˜¾ç¤ºçŠ¶æ€
        function resetSheetDisplay() {
            noteElements.forEach(el => {
                el.classList.remove('current', 'played');
            });
            currentNoteIndex = -1;
        }

        // æ’­æ”¾æŒ‰é’®äº‹ä»¶
        playBtn.addEventListener('click', () => {
            if (currentSheetId && !piano.isSheetPlaying()) {
                resetSheetDisplay();
                if (currentSheetItem) {
                    currentSheetItem.classList.add('playing');
                }
                updateControlButtons(true);
                piano.playSheet(currentSheetId, onNotePlay, onSheetEnd);
            }
        });

        // åœæ­¢æŒ‰é’®äº‹ä»¶
        stopBtn.addEventListener('click', () => {
            stopSheetUI();
        });

        // åˆ‡æ¢æ˜¾ç¤ºæ¨¡å¼æŒ‰é’®äº‹ä»¶
        notationBtn.addEventListener('click', () => {
            showKeyboard = !showKeyboard;
            
            // æ›´æ–°æŒ‰é’®æ–‡æœ¬
            const icon = notationBtn.querySelector('.notation-icon');
            const text = notationBtn.querySelector('.notation-text');
            if (showKeyboard) {
                icon.textContent = 'ğŸµ';
                text.textContent = 'éŸ³ç¬¦';
                notationBtn.classList.add('active');
            } else {
                icon.textContent = 'âŒ¨';
                text.textContent = 'æŒ‰é”®';
                notationBtn.classList.remove('active');
            }
            
            // é‡æ–°æ¸²æŸ“å½“å‰ç´è°±
            if (currentSheetId) {
                const savedIndex = currentNoteIndex;
                const playedIndices = [];
                noteElements.forEach((el, i) => {
                    if (el.classList.contains('played')) playedIndices.push(i);
                });
                
                renderSheet(currentSheetId);
                
                // æ¢å¤æ’­æ”¾çŠ¶æ€
                playedIndices.forEach(i => {
                    if (noteElements[i]) noteElements[i].classList.add('played');
                });
                if (savedIndex >= 0 && noteElements[savedIndex]) {
                    noteElements[savedIndex].classList.add('current');
                }
                currentNoteIndex = savedIndex;
            }
        });

        // ç´è°±ç‚¹å‡»äº‹ä»¶ - åªé€‰æ‹©å’Œæ˜¾ç¤ºï¼Œä¸æ’­æ”¾
        document.querySelectorAll('.sheet-item').forEach(item => {
            item.addEventListener('click', () => {
                const sheetId = item.dataset.sheet;
                
                // å¦‚æœæ­£åœ¨æ’­æ”¾ï¼Œå…ˆåœæ­¢
                if (piano.isSheetPlaying()) {
                    stopSheetUI();
                }

                // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                document.querySelectorAll('.sheet-item.active').forEach(i => {
                    i.classList.remove('active');
                });
                
                // é«˜äº®å½“å‰é€‰æ‹©çš„ç´è°±
                currentSheetItem = item;
                currentSheetItem.classList.add('active');
                currentSheetId = sheetId;
                
                // æ¸²æŸ“ç´è°±åˆ°ä¸­é—´é¢æ¿
                renderSheet(sheetId);
                
                // å¯ç”¨æ’­æ”¾æŒ‰é’®
                updateControlButtons(false);
            });
        });
    </script>
</body>
</html>
